<!-- File: src/views/home.ejs -->
<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>My Secret</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="/images/logo.png" type="image/png" />
    <link rel="stylesheet" href="/styles/main.css" />
    <link rel="stylesheet" href="/styles/home.css" />
  </head>
  <body>
    <div class="container">
      <header>
        <div class="user-info">
          <div class="avatar">
            <% if (user && user.avatarUrl) { %>
              <img src="<%= user.avatarUrl %>" alt="<%= user.displayName %>" />
            <% } else { %>
              <span>
                <%= user && user.displayName
                  ? user.displayName[0].toUpperCase()
                  : "U" %>
              </span>
            <% } %>
          </div>
          <div>
            <div style="font-weight: 600">
              <%= user ? user.displayName : "User" %>
            </div>
            <div class="muted">
              @<%= user ? user.username : "unknown" %>
            </div>
          </div>
        </div>

        <form action="/logout" method="post">
          <button type="submit" class="btn btn-secondary btn-logout">
            ƒêƒÉng xu·∫•t
          </button>
        </form>
      </header>

      <div class="grid">
        <!-- K·∫æT B·∫†N (tr√™n mobile s·∫Ω n·∫±m tr√™n) -->
        <section class="card home-card-add">
          <h2>K·∫øt b·∫°n</h2>

          <!-- N√∫t b·∫≠t th√¥ng b√°o (C√°ch 1) -->
          <div style="margin-top: 6px; margin-bottom: 10px;">
            <button
              type="button"
              class="btn btn-secondary"
              onclick="askNotificationPermissionManually()"
            >
              üîî B·∫≠t th√¥ng b√°o tin nh·∫Øn
            </button>
            <div class="muted" style="margin-top: 4px;">
              B·∫≠t l√™n ƒë·ªÉ nh·∫≠n th√¥ng b√°o khi c√≥ tin nh·∫Øn m·ªõi.
            </div>
          </div>

          <% if (flash) { %>
            <div
              class="alert <%= flash.type === 'error' ? 'alert-error' : 'alert-success' %>"
            >
              <%= flash.message %>
            </div>
          <% } %>

          <!-- M√É K·∫æT B·∫†N C·ª¶A M√åNH -->
          <div style="margin-bottom: 16px; margin-top: 8px;">
            <div class="form-group">
              <label class="muted">M√£ k·∫øt b·∫°n c·ªßa b·∫°n:</label>
              <div class="code-box">
                <span class="code-value" id="my-friend-code">
                  <%= myFriendCode && myFriendCode.code
                    ? myFriendCode.code
                    : "------" %>
                </span>

                <!-- üî• N√öT COPY M√É -->
                <button
                  type="button"
                  class="btn btn-secondary btn-copy-code"
                  onclick="copyFriendCode()"
                  style="margin-left: 8px;"
                >
                  Copy
                </button>

                <form method="POST" action="/home/friend-code">
                  <button class="btn btn-secondary" type="submit">
                    T·∫°o m√£ m·ªõi
                  </button>
                </form>
              </div>
              <div class="muted">
                <% if (myFriendCode && myFriendCode.expiresAt) { %>
                  H·∫øt h·∫°n l√∫c:
                  <%= new Date(myFriendCode.expiresAt).toLocaleString() %>
                <% } else { %>
                  Ch∆∞a t·∫°o m√£ n√†o.
                <% } %>
              </div>
            </div>
          </div>

          <!-- NH·∫¨P M√É K·∫æT B·∫†N -->
          <div style="margin-bottom: 16px">
            <div class="form-group">
              <label class="muted">Nh·∫≠p m√£ b·∫°n b√® g·ª≠i cho b·∫°n:</label>
              <form
                class="inline-form"
                method="POST"
                action="/home/friend-submit"
              >
                <input
                  class="input"
                  type="text"
                  name="code"
                  placeholder="VD: A1B2C3"
                  maxlength="10"
                  required
                />
                <button class="btn btn-primary" type="submit">
                  G·ª≠i y√™u c·∫ßu
                </button>
              </form>
            </div>
          </div>

          <!-- LIST Y√äU C·∫¶U CH·ªú DUY·ªÜT -->
          <div>
            <div
              style="
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin-bottom: 6px;
              "
            >
              <span class="muted">Y√™u c·∫ßu ƒëang ch·ªù b·∫°n duy·ªát:</span>
            </div>

            <div class="requests-list">
              <% if (pendingRequests && pendingRequests.length > 0) { %>
                <% pendingRequests.forEach(function (req) { %>
                  <div class="request-item">
                    <div class="request-main">
                      <div class="avatar">
                        <span>
                          <%= req.requester && req.requester.displayName
                                ? req.requester.displayName[0].toUpperCase()
                                : "U" %>
                        </span>
                      </div>
                      <div>
                        <div style="font-size: 13px; font-weight: 600">
                          <%= req.requester && req.requester.displayName
                                ? req.requester.displayName
                                : "Ng∆∞·ªùi d√πng ·∫©n danh" %>
                        </div>
                        <div class="muted">
                          <%= req.requester && req.requester.username
                                ? "@" + req.requester.username
                                : "" %>
                        </div>
                      </div>
                      <span class="tag">code: <%= req.code %></span>
                    </div>
                    <div class="actions">
                      <form
                        method="POST"
                        action="/home/friend-requests/<%= req.requestId %>/respond"
                        style="display: inline"
                      >
                        <input type="hidden" name="accept" value="true" />
                        <button
                          type="submit"
                          class="btn btn-primary"
                          style="padding: 4px 10px; font-size: 12px"
                        >
                          ƒê·ªìng √Ω
                        </button>
                      </form>
                      <form
                        method="POST"
                        action="/home/friend-requests/<%= req.requestId %>/respond"
                        style="display: inline"
                      >
                        <input type="hidden" name="accept" value="false" />
                        <button
                          type="submit"
                          class="btn btn-secondary"
                          style="padding: 4px 10px; font-size: 12px"
                        >
                          T·ª´ ch·ªëi
                        </button>
                      </form>
                    </div>
                  </div>
                <% }); %>
              <% } else { %>
                <span class="muted">Kh√¥ng c√≥ y√™u c·∫ßu n√†o.</span>
              <% } %>
            </div>
          </div>
        </section>

        <!-- DANH S√ÅCH B·∫†N B√à (tr√™n mobile s·∫Ω xu·ªëng d∆∞·ªõi) -->
        <section class="card home-card-friends">
          <h2>Danh s√°ch b·∫°n b√®</h2>
          <p class="muted" style="margin-bottom: 10px">
            Ch·ªçn 1 ng∆∞·ªùi ƒë·ªÉ m·ªü chat.
          </p>

          <div class="friends-list">
            <% if (friends && friends.length > 0) { %>
              <% friends.forEach(function (friend) { 
                   var unread = (unreadCounts && unreadCounts[friend._id]) || 0;
              %>
                <div
                  class="friend-item"
                  data-username="<%= friend.username %>"
                  data-unread="<%= unread %>"
                >
                  <div class="friend-main">
                    <div class="avatar">
                      <% if (friend.avatarUrl) { %>
                        <img
                          src="<%= friend.avatarUrl %>"
                          alt="<%= friend.displayName %>"
                        />
                      <% } else { %>
                        <span>
                          <%= friend.displayName
                            ? friend.displayName[0].toUpperCase()
                            : "F" %>
                        </span>
                      <% } %>
                    </div>
                    <div class="friend-text">
                      <span class="friend-name">
                        <%= friend.displayName %>
                        <% if (unread > 0) { %>
                          <span class="badge-unread">
                            <%= unread > 9 ? "9+" : unread %>
                          </span>
                        <% } %>
                      </span>
                      <span class="friend-username">
                        @<%= friend.username %>
                      </span>
                    </div>
                    <span
                      class="status-dot status-<%= friend.status || 'offline' %>"
                      title="<%= friend.status || 'offline' %>"
                    ></span>
                  </div>

                  <!-- URL chat ·∫©n username b·∫±ng key -->
                  <a
                    class="btn btn-primary btn-link"
                    href="<%= chatKeys && chatKeys[friend.username]
                      ? '/chat?key=' + chatKeys[friend.username]
                      : '/home' %>"
                  >
                    Chat
                  </a>
                </div>
              <% }); %>
            <% } else { %>
              <p class="muted">Ch∆∞a c√≥ b·∫°n b√® n√†o.</p>
            <% } %>
          </div>
        </section>
      </div>
    </div>

    <!-- DATA ·∫®N ƒê·ªÇ JS ƒê·ªåC, TR√ÅNH EJS CH√àN TR·ª∞C TI·∫æP V√ÄO JS -->
    <div id="home-data" data-current-user='<%- JSON.stringify(user || {}) %>'>
    </div>

    <!-- SOCKET.IO -->
    <script src="/socket.io/socket.io.js"></script>
    <script>
      (function () {
        var dataEl = document.getElementById("home-data");
        var CURRENT_USER = null;

        if (dataEl && dataEl.dataset.currentUser) {
          try {
            CURRENT_USER = JSON.parse(dataEl.dataset.currentUser);
          } catch (e) {
            CURRENT_USER = null;
          }
        }

        function updateFriendPresence(username, status) {
          if (!username) return;
          var selector = '.friend-item[data-username="' + username + '"]';
          var item = document.querySelector(selector);
          if (!item) return;

          var dot = item.querySelector(".status-dot");
          if (!dot) return;

          dot.classList.remove(
            "status-online",
            "status-offline",
            "status-busy",
            "status-away"
          );
          var st = status || "offline";
          dot.classList.add("status-" + st);
          dot.title = st;
        }

        // ====== SOCKET.IO KHI ƒê√É LOGIN ======
        var socket = null;
        if (CURRENT_USER && CURRENT_USER.username) {
          socket = io();

          socket.on("connect", function () {
            socket.emit("auth:identify", { username: CURRENT_USER.username });
          });

          // Realtime friend request
          socket.on("friend:newRequest", function () {
            window.location.reload();
          });

          socket.on("friend:updateList", function () {
            window.location.reload();
          });

          socket.on("friend:accepted", function () {
            window.location.reload();
          });

          // Realtime presence
          socket.on("presence:update", function (payload) {
            if (!payload || !payload.username) return;
            updateFriendPresence(payload.username, payload.status);
          });

          // üî• Realtime UNREAD: tƒÉng badge khi c√≥ chat:receive d√†nh cho m√¨nh
          socket.on("chat:receive", function (payload) {
            if (!payload || !CURRENT_USER || !CURRENT_USER.username) return;

            var me = (CURRENT_USER.username || "").toLowerCase();
            var from = (payload.from || "").toLowerCase();
            var to = (payload.to || "").toLowerCase();

            // Ch·ªâ x·ª≠ l√Ω khi M√åNH l√† ng∆∞·ªùi nh·∫≠n
            if (to !== me) return;

            var friendUsername = payload.from;
            var selector =
              '.friend-item[data-username="' + friendUsername + '"]';
            var item = document.querySelector(selector);
            if (!item) return;

            var currentUnread = parseInt(
              item.getAttribute("data-unread") || "0",
              10
            );
            if (isNaN(currentUnread)) currentUnread = 0;
            var newUnread = currentUnread + 1;
            item.setAttribute("data-unread", String(newUnread));

            var nameEl = item.querySelector(".friend-name");
            if (!nameEl) return;

            var badge = nameEl.querySelector(".badge-unread");
            if (!badge) {
              badge = document.createElement("span");
              badge.className = "badge-unread";
              nameEl.appendChild(badge);
            }
            badge.textContent = newUnread > 9 ? "9+" : String(newUnread);
          });
        }

        // ========== WEB PUSH: REGISTER SERVICE WORKER + SUBSCRIBE (C√ÅCH 1) ==========

        // SW register gi·ªØ l·∫°i ·ªü ƒë√¢y ƒë·ªÉ d√πng l·∫°i
        var swRegistration = null;

        // helper convert base64URL -> Uint8Array cho applicationServerKey
        function urlBase64ToUint8Array(base64String) {
          var padding = "=".repeat((4 - (base64String.length % 4)) % 4);
          var base64 = (base64String + padding)
            .replace(/-/g, "+")
            .replace(/_/g, "/");

          var rawData = window.atob(base64);
          var outputArray = new Uint8Array(rawData.length);

          for (var i = 0; i < rawData.length; ++i) {
            outputArray[i] = rawData.charCodeAt(i);
          }
          return outputArray;
        }

        // H√†m subscribe & g·ª≠i subscription l√™n server
        async function subscribeAndSend(reg) {
          try {
            if (!reg) {
              console.log("‚ùå Kh√¥ng c√≥ service worker registration.");
              return;
            }

            // L·∫•y public key t·ª´ backend
            const resKey = await fetch("/api/push/public-key");
            if (!resKey.ok) {
              console.log("‚ùå Kh√¥ng l·∫•y ƒë∆∞·ª£c VAPID public key.");
              return;
            }
            const keyJson = await resKey.json();
            const publicKey = keyJson.publicKey;
            if (!publicKey) {
              console.log("‚ùå Vapid public key r·ªóng.");
              return;
            }

            const appServerKey = urlBase64ToUint8Array(publicKey);

            // Ki·ªÉm tra ƒë√£ c√≥ subscription ch∆∞a
            let subscription = await reg.pushManager.getSubscription();
            if (!subscription) {
              subscription = await reg.pushManager.subscribe({
                userVisibleOnly: true,
                applicationServerKey: appServerKey,
              });
            }

            console.log("‚úÖ Push Subscription:", subscription);

            // G·ª≠i subscription l√™n server
            await fetch("/api/push/subscribe", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                subscription: subscription,
              }),
            });

            console.log("‚úÖ ƒê√£ g·ª≠i subscription l√™n server.");
          } catch (err) {
            console.error("‚ùå L·ªói subscribeAndSend:", err);
          }
        }

        // initPush: ch·ªâ t·ª± subscribe n·∫øu permission ƒë√£ "granted"
        async function initPush() {
          if (
            !("serviceWorker" in navigator) ||
            !("PushManager" in window) ||
            !("Notification" in window)
          ) {
            console.log("‚ö†Ô∏è Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ Web Push.");
            return;
          }

          try {
            // ƒêƒÉng k√Ω service worker (ch·ªâ c·∫ßn l√†m 1 l·∫ßn)
            swRegistration =
              swRegistration ||
              (await navigator.serviceWorker.register("/sw.js"));
            console.log("‚úÖ Service Worker registered:", swRegistration.scope);

            // N·∫øu user ƒë√£ cho ph√©p t·ª´ tr∆∞·ªõc -> auto subscribe
            if (Notification.permission === "granted") {
              await subscribeAndSend(swRegistration);
            } else {
              console.log(
                "üîî Notification permission hi·ªán t·∫°i:",
                Notification.permission
              );
              // Ch∆∞a cho ph√©p -> ch·ªù user b·∫•m n√∫t "B·∫≠t th√¥ng b√°o"
            }
          } catch (err) {
            console.error("‚ùå L·ªói initPush:", err);
          }
        }

        // H√†m cho n√∫t "B·∫≠t th√¥ng b√°o tin nh·∫Øn" g·ªçi
        async function askNotificationPermissionManually() {
          if (!("Notification" in window)) {
            alert("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ th√¥ng b√°o.");
            return;
          }

          // N·∫øu ƒë√£ cho ph√©p r·ªìi
          if (Notification.permission === "granted") {
            alert("B·∫°n ƒë√£ b·∫≠t th√¥ng b√°o r·ªìi.");
            // ƒê·∫£m b·∫£o ƒë√£ register SW v√† subscribe
            await initPush();
            return;
          }

          // N·∫øu ƒë√£ ch·∫∑n tr∆∞·ªõc ƒë√≥
          if (Notification.permission === "denied") {
            alert(
              "B·∫°n ƒë√£ ch·∫∑n th√¥ng b√°o. H√£y v√†o c√†i ƒë·∫∑t tr√¨nh duy·ªát ƒë·ªÉ b·∫≠t l·∫°i quy·ªÅn th√¥ng b√°o cho trang n√†y."
            );
            return;
          }

          // "default" -> xin quy·ªÅn
          const result = await Notification.requestPermission();
          if (result === "granted") {
            alert("ƒê√£ b·∫≠t th√¥ng b√°o!");
            await initPush(); // ƒëƒÉng k√Ω SW + subscribe + g·ª≠i l√™n server
          } else {
            alert("B·∫°n ch∆∞a cho ph√©p th√¥ng b√°o.");
          }
        }

        // üî• H√ÄM COPY M√É K·∫æT B·∫†N
        async function copyFriendCode() {
          var el = document.getElementById("my-friend-code");
          if (!el) {
            alert("Kh√¥ng t√¨m th·∫•y m√£ k·∫øt b·∫°n.");
            return;
          }

          var code = (el.textContent || "").trim();
          if (!code || code === "------") {
            alert("Ch∆∞a c√≥ m√£ ƒë·ªÉ copy. H√£y b·∫•m 'T·∫°o m√£ m·ªõi' tr∆∞·ªõc.");
            return;
          }

          try {
            if (navigator.clipboard && navigator.clipboard.writeText) {
              await navigator.clipboard.writeText(code);
            } else {
              // fallback c≈© (r·∫•t hi·∫øm khi c·∫ßn)
              var temp = document.createElement("textarea");
              temp.value = code;
              document.body.appendChild(temp);
              temp.select();
              document.execCommand("copy");
              document.body.removeChild(temp);
            }
            alert("ƒê√£ copy m√£: " + code);
          } catch (err) {
            console.error("L·ªói copyFriendCode:", err);
            alert("Kh√¥ng copy ƒë∆∞·ª£c m√£. Th·ª≠ copy tay nh√©.");
          }
        }

        // Cho HTML g·ªçi ƒë∆∞·ª£c
        window.askNotificationPermissionManually =
          askNotificationPermissionManually;
        window.copyFriendCode = copyFriendCode;

        // Ch·ªâ init push n·∫øu ƒë√£ login
        if (CURRENT_USER && CURRENT_USER.username) {
          initPush();
        }
      })();
    </script>
  </body>
</html>
