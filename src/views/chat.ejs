<!-- File: src/views/chat.ejs -->
<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title><%= siteTitle || "My Secret" %></title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      rel="icon"
      href="<%= logoUrl || '/images/logo.png' %>"
      type="image/png"
    />
    <link rel="stylesheet" href="/styles/main.css" />
    <link rel="stylesheet" href="/styles/chat.css" />
  </head>
  <body class="chat-body">
    <div class="chat-shell">
      <header class="chat-header">
        <button class="back-link" onclick="window.location.href='/home'">
          <span>‚Üê</span>
          <span>V·ªÅ trang ch·ªß</span>
        </button>

        <div class="peer-info">
          <div class="avatar">
            <% if (peer && peer.avatarUrl) { %>
              <img src="<%= peer.avatarUrl %>" alt="<%= peer.displayName %>" />
            <% } else { %>
              <span>
                <%= peer && peer.displayName
                  ? peer.displayName[0].toUpperCase()
                  : "P" %>
              </span>
            <% } %>
          </div>
          <div class="peer-text">
            <span class="peer-name">
              <%= peer
                ? peer.displayName || peer.username || "Ng∆∞·ªùi d√πng"
                : "Ng∆∞·ªùi d√πng" %>
            </span>
            <span class="peer-username">
              @<%= peer ? peer.username : "unknown" %>
            </span>
          </div>
          <span
            class="status-dot peer-status-dot status-<%= peer && peer.status ? peer.status : 'offline' %>"
            title="<%= peer && peer.status ? peer.status : 'offline' %>"
          ></span>
        </div>
      </header>

      <section class="chat-main">
        <!-- ALERT -->
        <div
          id="chat-alert"
          class="alert alert-error"
          style="display: none"
        ></div>

        <!-- KHUNG MESSAGE C·ªê ƒê·ªäNH, CU·ªòN B√äN TRONG -->
        <div id="messages" class="messages"></div>

        <!-- typing indicator -->
        <div
          id="typing-indicator"
          class="typing-indicator"
          style="
            display: none;
            font-size: 12px;
            color: #6b7280;
            padding: 0 4px 4px 4px;
          "
        ></div>

        <!-- INPUT BAR C·ªê ƒê·ªäNH D∆Ø·ªöI C√ôNG -->
        <form id="chat-form" class="input-row">
          <input
            id="message-input"
            class="input"
            type="text"
            autocomplete="off"
            placeholder="Nh·∫≠p tin nh·∫Øn..."
          />

          <!-- N√öT EMOJI -->
          <button
            type="button"
            id="emoji-toggle-btn"
            class="emoji-toggle-btn"
            title="Ch√®n emoji"
          >
            üòä
          </button>

          <button class="btn btn-primary" type="submit">G·ª≠i</button>
        </form>
      </section>
    </div>

    <!-- DATA ·∫®N ƒê·ªÇ JS ƒê·ªåC -->
    <div
      id="chat-data"
      data-current-user='<%- JSON.stringify(user || {}) %>'
      data-peer-user='<%- JSON.stringify(peer || {}) %>'
    ></div>

    <!-- Socket.io -->
    <script src="/socket.io/socket.io.js"></script>

    <!-- Emoji Button CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@joeattardi/emoji-button@3.0.3/dist/index.min.js"></script>

    <script>
      (function () {
        // ===== L·∫§Y DATA USER / PEER T·ª™ DOM =====
        var dataEl = document.getElementById("chat-data");
        var CURRENT_USER = null;
        var PEER_USER = null;

        if (dataEl) {
          if (dataEl.dataset.currentUser) {
            try {
              CURRENT_USER = JSON.parse(dataEl.dataset.currentUser);
            } catch (e) {
              CURRENT_USER = null;
            }
          }
          if (dataEl.dataset.peerUser) {
            try {
              PEER_USER = JSON.parse(dataEl.dataset.peerUser);
            } catch (e2) {
              PEER_USER = null;
            }
          }
        }

        // ===== SOCKET.IO K·∫æT N·ªêI M·∫∂C ƒê·ªäNH T·ªöI C√ôNG ORIGIN =====
        var socket = io();

        // ===== QUERY ELEMENT =====
        var messagesEl = document.getElementById("messages");
        var alertEl = document.getElementById("chat-alert");
        var formEl = document.getElementById("chat-form");
        var inputEl = document.getElementById("message-input");
        var peerStatusDot = document.querySelector(".peer-status-dot");
        var emojiToggleBtn = document.getElementById("emoji-toggle-btn");
        var typingEl = document.getElementById("typing-indicator");

        // ===== COMMON UI FUNCS =====
        function showError(msg) {
          if (!alertEl) return;
          alertEl.style.display = "block";
          alertEl.textContent = msg;
          setTimeout(function () {
            alertEl.style.display = "none";
          }, 3500);
        }

        function formatTime(dateStr) {
          var d = new Date(dateStr);
          if (isNaN(d.getTime())) return "";
          var hh = String(d.getHours()).padStart(2, "0");
          var mm = String(d.getMinutes()).padStart(2, "0");
          return hh + ":" + mm;
        }

        function appendMessage(msg) {
          if (!messagesEl) return;

          var currentUsername = CURRENT_USER && CURRENT_USER.username;
          var isMe =
            msg.from === currentUsername ||
            (msg.sender && msg.sender.username === currentUsername);

          var row = document.createElement("div");
          row.className = "bubble-row " + (isMe ? "me" : "other");

          var bubble = document.createElement("div");
          bubble.className = "bubble " + (isMe ? "me" : "other");
          bubble.textContent = msg.message || msg.content || "";
          row.appendChild(bubble);
          messagesEl.appendChild(row);

          var meta = document.createElement("div");
          meta.className = "msg-meta " + (isMe ? "me" : "other");
          meta.textContent = formatTime(msg.at || msg.createdAt);
          messagesEl.appendChild(meta);

          messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        function renderHistory(list) {
          if (!messagesEl) return;
          messagesEl.innerHTML = "";
          (list || []).forEach(function (m) {
            appendMessage({
              from: m.sender ? m.sender.username : undefined,
              message: m.content,
              at: m.at || m.createdAt,
            });
          });
        }

        function updatePeerPresence(status) {
          if (!peerStatusDot) return;
          peerStatusDot.classList.remove(
            "status-online",
            "status-offline",
            "status-busy",
            "status-away"
          );
          var st = status || "offline";
          peerStatusDot.classList.add("status-" + st);
          peerStatusDot.title = st;
        }

        // ===== EMOJI BUTTON (LIB) =====
        var emojiPicker = null;
        if (window.EmojiButton) {
          emojiPicker = new EmojiButton({
            position: "top-end",
            zIndex: 9999,
          });
        }

        function insertEmojiIntoInput(emojiChar) {
          if (!inputEl || !emojiChar) return;
          var start = inputEl.selectionStart || inputEl.value.length;
          var end = inputEl.selectionEnd || inputEl.value.length;
          var current = inputEl.value;
          inputEl.value =
            current.substring(0, start) +
            emojiChar +
            current.substring(end);
          var caret = start + emojiChar.length;
          inputEl.selectionStart = caret;
          inputEl.selectionEnd = caret;
          inputEl.focus();
        }

        if (emojiToggleBtn && emojiPicker && inputEl) {
          emojiToggleBtn.addEventListener("click", function (e) {
            e.preventDefault();
            emojiPicker.togglePicker(emojiToggleBtn);
          });

          emojiPicker.on("emoji", function (selection) {
            var emojiChar =
              selection && selection.emoji ? selection.emoji : selection;
            insertEmojiIntoInput(emojiChar);
          });
        }

        // ===== IS TYPING (CLIENT) =====
        var isTyping = false;

        function emitTyping(isTypingFlag) {
          if (!CURRENT_USER || !PEER_USER) return;
          socket.emit("chat:typing", {
            from: CURRENT_USER.username,
            to: PEER_USER.username,
            isTyping: !!isTypingFlag,
          });
        }

        function syncTypingState() {
          if (!inputEl) return;
          var text = inputEl.value;

          if (text && !isTyping) {
            isTyping = true;
            emitTyping(true);
          }

          if (!text && isTyping) {
            isTyping = false;
            emitTyping(false);
          }
        }

        if (inputEl) {
          inputEl.addEventListener("input", function () {
            syncTypingState();
          });

          inputEl.addEventListener("blur", function () {
            if (isTyping) {
              isTyping = false;
              emitTyping(false);
            }
          });
        }

        function showPeerTyping(flag) {
          if (!typingEl) return;
          if (flag) {
            typingEl.style.display = "block";
            typingEl.textContent =
              (PEER_USER &&
                (PEER_USER.displayName || PEER_USER.username || "B·∫°n")) +
              " ƒëang nh·∫≠p...";
          } else {
            typingEl.style.display = "none";
          }
        }

        socket.on("chat:typing", function (payload) {
          if (!CURRENT_USER || !PEER_USER || !payload) return;

          var from = (payload.from || "").toLowerCase();
          var to = (payload.to || "").toLowerCase();
          var peerName = (PEER_USER.username || "").toLowerCase();
          var meName = (CURRENT_USER.username || "").toLowerCase();

          var isForThisChat = from === peerName && to === meName;
          if (!isForThisChat) return;

          showPeerTyping(!!payload.isTyping);
        });

        // ===== AUTH + PRESENCE =====
        if (CURRENT_USER && CURRENT_USER.username) {
          socket.on("connect", function () {
            socket.emit("auth:identify", { username: CURRENT_USER.username });
          });

          socket.on("presence:update", function (payload) {
            if (!payload || !payload.username) return;
            if (PEER_USER && payload.username === PEER_USER.username) {
              updatePeerPresence(payload.status);
            }
          });
        }

        // ===== CHAT HISTORY =====
        if (!CURRENT_USER || !PEER_USER) {
          showError("Thi·∫øu th√¥ng tin user ho·∫∑c b·∫°n chat.");
        } else {
          socket.emit("chat:getHistory", {
            from: CURRENT_USER.username,
            to: PEER_USER.username,
            limit: 20,
          });
        }

        socket.on("chat:history", function (payload) {
          if (
            !CURRENT_USER ||
            !PEER_USER ||
            !(
              (payload.from === CURRENT_USER.username &&
                payload.to === PEER_USER.username) ||
              (payload.to === CURRENT_USER.username &&
                payload.from === PEER_USER.username)
            )
          ) {
            return;
          }
          renderHistory(payload.messages || []);
        });

        socket.on("chat:historyError", function (err) {
          showError(
            (err && err.message) || "Kh√¥ng l·∫•y ƒë∆∞·ª£c l·ªãch s·ª≠ chat"
          );
        });

        // ===== NH·∫¨N TIN NH·∫ÆN =====
        socket.on("chat:receive", function (payload) {
          if (!CURRENT_USER || !PEER_USER || !payload) return;

          var inThisChat =
            (payload.from === CURRENT_USER.username &&
              payload.to === PEER_USER.username) ||
            (payload.to === CURRENT_USER.username &&
              payload.from === PEER_USER.username);

          if (!inThisChat) return;

          appendMessage(payload);
          showPeerTyping(false);
        });

        socket.on("chat:error", function (err) {
          showError(
            (err && err.message) || "Kh√¥ng g·ª≠i ƒë∆∞·ª£c tin nh·∫Øn"
          );
        });

        // ===== G·ª¨I TIN NH·∫ÆN =====
        if (formEl && inputEl) {
          formEl.addEventListener("submit", function (e) {
            e.preventDefault();
            if (!CURRENT_USER || !PEER_USER) {
              showError("Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c ng∆∞·ªùi g·ª≠i / ng∆∞·ªùi nh·∫≠n.");
              return;
            }
            var text = inputEl.value.trim();
            if (!text) return;

            socket.emit("chat:send", {
              from: CURRENT_USER.username,
              to: PEER_USER.username,
              message: text,
            });

            inputEl.value = "";
            if (isTyping) {
              isTyping = false;
              emitTyping(false);
            }
          });
        }
      })();
    </script>
  </body>
</html>
